const e=require("express"),t=require("cors"),s=require("node-fetch"),r=e();r.use(t({origin:"*",methods:["GET","POST","PUT","DELETE","OPTIONS"],allowedHeaders:["Content-Type","Authorization","X-Requested-With","Accept"],credentials:!0})),r.all("*",(async(e,t)=>{if("OPTIONS"===e.method)return t.status(200).end();try{const r={};Object.keys(e.headers).forEach((t=>{"host"!==t.toLowerCase()&&"content-length"!==t.toLowerCase()&&(r[t]=e.headers[t])}));const o=await s("https://cloudkuimages.guru/",{method:e.method,headers:r,body:"GET"!==e.method&&"HEAD"!==e.method?e:undefined});o.headers.forEach(((e,s)=>{s.toLowerCase().startsWith("access-control-")||t.setHeader(s,e)})),t.status(o.status),o.body.pipe(t)}catch(r){console.error("Gateway Error:",r),t.headersSent||t.status(502).json({error:"Bad Gateway",message:"Failed to communicate with upstream server.",details:r.message})}})),module.exports=r;
